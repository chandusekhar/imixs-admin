"use strict";var BENJS=BENJS||{};BENJS.namespace=function(d){var c=d.split("."),b=BENJS,a;if(c[0]==="BENJS"){c=c.slice(1)}for(a=0;a<c.length;a+=1){if(typeof b[c[a]]==="undefined"){b[c[a]]={}}b=b[c[a]]}return b};BENJS.namespace("org.benjs.core");BENJS.org.benjs.core=(function(){console.debug("------------------------");console.debug("Ben.js: Version 0.1.0");console.debug("------------------------");var _controllers=new Array(),_templates=new Array(),_routes=new Array(),createController=function(settings){settings=settings||{};if(!settings.id){console.error("createController wrong settings provided: id missing!");return false}console.debug("register new controller: '"+settings.id+"'");var aController=new BenController(settings);_controllers.push(aController);return aController},createTemplate=function(settings){settings=settings||{};if(!settings.id){console.error("createTemplate wrong settings provided: id missing!");return false}console.debug("register new template: '"+settings.id+"' view='"+settings.url+"'");var aTemplate=new BenTemplate(settings);_templates.push(aTemplate);return aTemplate},createRoute=function(settings){settings=settings||{};if(!settings.id){console.error("createController wrong settings provided: id missing!");return false}console.debug("register new route: '"+settings.id+"'");var aRoute=new BenRouter(settings);_routes.push(aRoute);return aRoute},findControllerByID=function(id){var result;$.each(_controllers,function(index,contrl){if(contrl.id===id){result=contrl;return false}});if(result){return result}else{console.error("ERROR: Controler '"+id+"' not registered")}},findTemplateByID=function(id){var result;$.each(_templates,function(index,templ){if(templ.id===id){result=templ;return false}});if(result){return result}else{console.error("ERROR: Template'"+id+"' not registered")}},_read_section=function(selectorId,model){$(selectorId).find(":input").each(function(){var modelValue,modelField;modelField=$(this).attr("data-ben-model");if(modelField){modelValue="";switch(this.type){case"text":case"hidden":case"password":case"select-multiple":case"select-one":case"textarea":modelValue=$(this).val();model[modelField]=modelValue;break;case"checkbox":case"radio":this.checked=false}}})},start=function(config){console.debug("starting application...");if(config===undefined){config={loadTemplatesOnStartup:true}}console.debug("configuration=",config);$.each(_controllers,function(index,contrl){contrl.init()});if(config.loadTemplatesOnStartup){$.each(_templates,function(index,templ){templ.load()})}},BenController=function(settings){settings=settings||{};var that=this;this.id=settings.id;this.model=settings.model;this.view=settings.view;if(typeof settings.autoRefresh=="undefined"){this.autoRefresh=true}else{this.autoRefresh=settings.autoRefresh}this.foreachCache=new Array();this.beforePush=$.Callbacks();this.afterPush=$.Callbacks();this.beforePull=$.Callbacks();this.afterPull=$.Callbacks();if(typeof settings.beforePush==="function"){this.beforePush.add(settings.beforePush)}if(typeof settings.afterPush==="function"){this.afterPush.add(settings.afterPush)}if(typeof settings.beforePull==="function"){this.beforePull.add(settings.beforePull)}if(typeof settings.afterPull==="function"){this.afterPull.add(settings.afterPull)}this.init=function(context){this.foreachCache=new Array();var selectorId="[data-ben-controller='"+this.id+"']";if($(selectorId,context).length){console.debug("controller: '"+this.id+"' init...");if(that.view){that.load(that.view,context)}else{that.push(context)}}};this.push=function(context){var selectorId="[data-ben-controller='"+this.id+"']",pushContext=$(selectorId,context);console.debug("controller: '"+that.id+"' -> push model=",that.model);that.beforePush.fire(that,pushContext);$(pushContext).each(function(){that._update(this,that.model)});that.afterPush.fire(that,pushContext)};this.pull=function(){var selectorId="[data-ben-controller='"+this.id+"']",pullContext=$(selectorId);that.beforePull.fire(that,pullContext);_read_section(selectorId,this.model);console.debug("pull model from view '"+this.id+"': Model=",this.model);that.afterPull.fire(that,pullContext)};this.load=function(url,searchcontext){this.foreachCache=new Array();if(!url){if(that.view){url=that.view}}if(url){var selectorId="[data-ben-controller='"+this.id+"']";$(selectorId,searchcontext).each(function(){console.debug("controller: '"+that.id+"' -> load '"+url+"'...");var context=$(this).parent();$(this).load(url,function(response,status,xhr){if(status==="error"){$(this).prepend("<!-- WARNING controller-view '"+url+"' not found -->");console.debug("controller-view '"+url+"' not found!");that.push(context)}else{that.push(context)}})})}};this._update=function(selector,model){$(selector).find("[data-ben-foreach]").each(function(){var foreachID;foreachID=$(this).attr("data-ben-foreach-id");if(!foreachID){foreachID=that.foreachCache.length;$(this).attr("data-ben-foreach-id",foreachID);that.foreachCache.push("")}});$(selector).find("[data-ben-model]").each(function(){var modelField,parentForEachBlocks,selectorForEachBlocks;modelField=$(this).attr("data-ben-model");parentForEachBlocks=$(this).closest("[data-ben-foreach]");selectorForEachBlocks=$(selector).closest("[data-ben-foreach]");if(parentForEachBlocks.length===0||$(parentForEachBlocks).get(0)===$(selectorForEachBlocks).get(0)){that._update_element(this,modelField,model)}else{}});$(selector).find("[data-ben-foreach]").each(function(){var parent,modelField,foreachID,foreachModel,forEachBlock,forEachBlockContent,resolveAs,_prototypeClass;modelField=$(this).attr("data-ben-foreach");foreachID=$(this).attr("data-ben-foreach-id");if(modelField.indexOf(" as ")>-1){resolveAs=modelField.split(" ");modelField=resolveAs[0].trim();_prototypeClass=resolveAs[2].trim()}parent=$(this).parent("[data-ben-foreach]");foreachModel=that._extract_model_value(modelField,model);if(parent.length===0&&foreachModel&&$.isArray(foreachModel)){forEachBlock=$(this);if(foreachID){if(foreachID>=that.foreachCache.length){console.debug("WARNING - wrong foreachCach length!")}forEachBlockContent=that.foreachCache[foreachID]}if(!forEachBlockContent){console.debug("caching foreach block: "+foreachID);forEachBlockContent=forEachBlock.clone().html().trim();that.foreachCache[foreachID]=forEachBlockContent}if(forEachBlockContent.indexOf("<")!=0||forEachBlockContent.indexOf("<!--")===0){forEachBlockContent='<span data-ben-entry="">'+forEachBlockContent+"</span>"}$(this).empty();if($.isArray(foreachModel)){$.each(foreachModel,function(index,model_element){var newEntry,evalString;if(_prototypeClass){evalString="model_element =new "+_prototypeClass+"(model_element);";eval(evalString)}newEntry=$.parseHTML(forEachBlockContent);$(newEntry).attr("data-ben-entry",index);$(forEachBlock).append(newEntry);that._update(newEntry,model_element)})}}})};this._update_element=function(selector,modelField,model){var modelAttribute,attrPos,modelValue;if(modelField){if(modelField.match("^::")){attrPos=modelField.indexOf("::",2);modelAttribute=modelField.substring(2,attrPos);modelField=modelField.substring(attrPos+2)}modelValue=that._extract_model_value(modelField,model);if(modelAttribute){$(selector).attr(modelAttribute,modelValue)}else{if(!selector.type&&$(selector).text){$(selector).html(modelValue)}else{switch(selector.type){case"text":case"hidden":case"password":case"select-multiple":case"select-one":case"textarea":$(selector).val(modelValue);break;case"checkbox":case"radio":$(selector).checked=false}}}}};this._extract_model_value=function(modelField,model){var modelValue;if(modelField){modelField=modelField.trim();if(modelField.indexOf("(")>-1){if(modelField.match("^[_a-zA-Z0-9.]+\\(")){try{modelValue=eval("model."+modelField)}catch(err){console.error("Error calling gettermethod '"+modelField+"' -> "+err.message)}}else{console.error("Error invalid method call -> "+modelField)}}else{if(modelField==="."){modelValue=model}else{if(!modelField.match("^model.")){modelField="model."+modelField}modelValue=eval(modelField)}}if((typeof(modelValue)==="undefined")){modelValue=""}return modelValue}}},BenTemplate=function(settings){settings=settings||{};var that=this;this.id=settings.id;this.url=settings.url;this.beforeLoad=$.Callbacks();this.afterLoad=$.Callbacks();if(typeof settings.beforeLoad==="function"){this.beforeLoad.add(settings.beforeLoad)}if(typeof settings.afterLoad==="function"){this.afterLoad.add(settings.afterLoad)}this.load=function(url){if(url){that.url=url}if(!that.url){console.debug("Warning: temlate '"+that.id+"' can't be loaded: no url defined!");return false}var selectorId="[data-ben-template='"+that.id+"']";$(selectorId).each(function(){console.debug("template: '"+that.id+"' -> load '"+that.url+"'...");that.beforeLoad.fire(that,$(this));$(this).load(that.url,function(response,status,xhr){var template_error,templateContext=$(this);if(status==="error"){template_error="Error loading template '"+that.url+"': not found";console.error(template_error);$(this).prepend("<!-- "+template_error+" -->")}else{console.debug("template: '"+that.id+"' loaded");$(templateContext).find("[data-ben-controller]").each(function(){var cntrl=BENJS.org.benjs.core.findControllerByID($(this).attr("data-ben-controller"));if(cntrl&&cntrl.autoRefresh===true){cntrl.init(templateContext)}})}that.afterLoad.fire(that,$(templateContext))})})}},BenRouter=function(settings){settings=settings||{};var that=this;this.id=settings.id;this.templates=settings.templates;this.beforeRoute=$.Callbacks();this.afterRoute=$.Callbacks();this.templateCount=0;if(typeof settings.beforeRoute==="function"){this.beforeRoute.add(settings.beforeRoute)}if(typeof settings.afterRoute==="function"){this.afterRoute.add(settings.afterRoute)}this.route=function(){console.debug("route: '"+that.id+"'...");that.beforeRoute.fire(that);var keys=Object.keys(that.templates);$.each(keys,function(index,templID){var templ=benJS.findTemplateByID(templID);if(templ){that.templateCount++;templ.afterLoad.add(that._templateOnLoad);templ.load(that.templates[templID],false)}})};this._templateOnLoad=function(templ){templ.afterLoad.remove(that._templateOnLoad);that.templateCount--;if(that.templateCount===0){document.location.href="#"+that.id;console.debug("route: '"+that.id+"' complete");that.afterRoute.fire(that)}}};return{start:start,createController:createController,createTemplate:createTemplate,createRoute:createRoute,findControllerByID:findControllerByID,findTemplateByID:findTemplateByID}}());