"use strict";var Ben=function(){console.debug("------------------------");console.debug("Ben.js: Version 0.0.8");console.debug("------------------------");var a=this;this._controllers=new Array();this._templates=new Array();this._routes=new Array();this.createController=function(e,d,c){console.debug("register new controller: '"+e+"'");var b=new BenController(e,d,c);a._controllers.push(b);return b};this.createRoute=function(c,d){console.debug("register new route: '"+c+"'");var b=new BenRouter(c,d);a._routes.push(b);return b};this.createTemplate=function(d,b){console.debug("register new template: '"+d+"' view='"+b+"'");var c=new BenTemplate(d,b);a._templates.push(c);return c};this.findControllerByID=function(c){var b;$.each(a._controllers,function(d,e){if(e.id===c){b=e;return false}});if(b){return b}else{console.error("ERROR: Controler '"+c+"' not registered")}};this.findTemplateByID=function(c){var b;$.each(a._templates,function(d,e){if(e.id===c){b=e;return false}});if(b){return b}else{console.error("ERROR: Template'"+c+"' not registered")}};this.start=function(b){if(b===undefined){b={loadTemplatesOnStartup:true}}console.debug("starting application...");console.debug("configuration=",b);$.each(a._controllers,function(c,d){d.init()});if(b.loadTemplatesOnStartup){$.each(a._templates,function(c,d){d.load()})}}};function BenController(id,model,view){var that=this;this.id=id;this.model=model;this.view=view;this.beforePush=$.Callbacks();this.afterPush=$.Callbacks();this.beforePull=$.Callbacks();this.afterPull=$.Callbacks();this.init=function(context){var selectorId="[data-ben-controller='"+this.id+"']";if($(selectorId,context).length){console.debug("controller: '"+this.id+"' init...");if(that.view){that.load(that.view,context)}else{that.push(context)}}};this.push=function(context){var selectorId="[data-ben-controller='"+this.id+"']";console.debug("controller: '"+that.id+"' -> push model=",that.model);that.beforePush.fire(that);$(selectorId,context).each(function(){that._update(this,that.model)});that.afterPush.fire(that)};this.pull=function(){that.beforePull.fire(that,$(this));var selectorId="[data-ben-controller='"+this.id+"']";_read_section(selectorId,this.model);console.debug("pull model from view '"+this.id+"': Model=",this.model);that.afterPull.fire(that,$(this))};this.load=function(url,searchcontext){if(!url){if(that.view){url=that.view}}if(url){var selectorId="[data-ben-controller='"+this.id+"']";$(selectorId,searchcontext).each(function(){console.debug("controller: '"+that.id+"' -> load '"+url+"'...");var context=$(this).parent();$(this).load(url,function(response,status,xhr){if(status==="error"){$(this).prepend("<!-- WARNING controller-view '"+url+"' not found -->");console.debug("controller-view '"+url+"' not found!");that.push(context)}else{that.push(context)}})})}};this._update=function(selector,model){$(selector).find("[data-ben-model]").each(function(){var modelField=$(this).attr("data-ben-model");var parentForEachBlocks=$(this).closest("[data-ben-foreach]");var selectorForEachBlocks=$(selector).closest("[data-ben-foreach]");if(parentForEachBlocks.length===0||$(parentForEachBlocks).get(0)===$(selectorForEachBlocks).get(0)){that._update_element(this,modelField,model)}else{}});$(selector).find("[data-ben-foreach]").each(function(){var modelField=$(this).attr("data-ben-foreach");var _prototypeClass;if(modelField.indexOf(" as ")>-1){var res=modelField.split(" ");modelField=res[0].trim();_prototypeClass=res[2].trim()}var parent=$(this).parent("[data-ben-foreach]");var foreachModel=that._extract_model_value(modelField,model);if(parent.length===0&&foreachModel&&$.isArray(foreachModel)){var forEachBlock=$(this);var forEachBlockContent=forEachBlock.clone().html().trim();if(forEachBlockContent.indexOf("<")!=0||forEachBlockContent.indexOf("<!--")===0||$(this).children().length>1){forEachBlockContent='<span data-ben-entry="">'+forEachBlockContent+"</span>"}$(this).empty();if($.isArray(foreachModel)){$.each(foreachModel,function(index,model_element){if(_prototypeClass){var evalString="model_element =new "+_prototypeClass+"(model_element);";eval(evalString)}var newEntry=$.parseHTML(forEachBlockContent);$(newEntry).attr("data-ben-entry",index);$(forEachBlock).append(newEntry);that._update(newEntry,model_element)})}}})};this._update_element=function(selector,modelField,model){var modelAttribute;if(modelField){if(modelField.match("^::")){var n=modelField.indexOf("::",2);modelAttribute=modelField.substring(2,n);modelField=modelField.substring(n+2)}var modelValue=that._extract_model_value(modelField,model);if(modelAttribute){$(selector).attr(modelAttribute,modelValue)}else{if(!selector.type&&$(selector).text){$(selector).text(modelValue)}else{switch(selector.type){case"text":case"hidden":case"password":case"select-multiple":case"select-one":case"textarea":$(selector).val(modelValue);break;case"checkbox":case"radio":$(selector).checked=false}}}}};this._extract_model_value=function(modelField,model){if(modelField){modelField=modelField.trim();var modelValue;if(modelField.indexOf("(")>-1){if(modelField.match("^[_a-zA-Z0-9]+\\(")){try{modelValue=eval("model."+modelField)}catch(err){console.error("Error calling gettermethod '"+modelField+"' -> "+err.message)}}else{console.error("Error invalid method call -> "+modelField)}}else{if(modelField==="."){modelValue=model}else{if(!modelField.match("^model.")){modelField="model."+modelField}modelValue=eval(modelField)}}if((typeof(modelValue)==="undefined")){modelValue=""}return modelValue}}}function BenTemplate(c,a){var b=this;this.id=c;this.url=a;this.beforeLoad=$.Callbacks();this.afterLoad=$.Callbacks();this.load=function(d,f){if(d){b.url=d}if(!b.url){return false}var e="[data-ben-template='"+b.id+"']";$(e,f).each(function(){console.debug("template: '"+b.id+"' -> load '"+b.url+"'...");b.beforeLoad.fire(b,$(this));$(this).load(b.url,function(h,g,k){var j=$(this);if(g==="error"){var i="Error loading template '"+b.url+"': not found";console.error(i);$(this).prepend("<!-- "+i+" -->")}else{console.debug("template: '"+b.id+"' loaded");$(j).find("[data-ben-controller]").each(function(){var l=benJS.findControllerByID($(this).attr("data-ben-controller"));if(l){l.init(j)}})}b.afterLoad.fire(b,$(j))})})}}function BenRouter(c,a){var b=this;this.id=c;this.config=a;this.beforeRoute=$.Callbacks();this.afterRoute=$.Callbacks();this.templateCount=0;this.route=function(){console.debug("route: '"+b.id+"'...");b.beforeRoute.fire(b);var d=Object.keys(b.config);$.each(d,function(e,f){var g=benJS.findTemplateByID(f);if(g){g.url=b.config[f];g.afterLoad.add(b._templateOnLoad);b.templateCount++;g.load()}})};this._templateOnLoad=function(d){d.afterLoad.remove(b._templateOnLoad);b.templateCount--;if(b.templateCount===0){document.location.href="#"+b.id;console.debug("route: '"+b.id+"' complete");b.afterRoute.fire(b)}}}function _read_section(b,a){$(b).find(":input").each(function(){var d=$(this).attr("data-ben-model");if(d){var c="";switch(this.type){case"text":case"hidden":case"password":case"select-multiple":case"select-one":case"textarea":c=$(this).val();a[d]=c;break;case"checkbox":case"radio":this.checked=false}}})}var benJS=new Ben();